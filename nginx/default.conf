server {
  listen 80;
  server_name _;

  # Allow large file uploads (for query images)
  client_max_body_size 500M;
  client_body_timeout 120s;

  # Root - serve index.html from frontend
  location = / {
    root /app/frontend;
    try_files /index.html =404;
  }

  # Frontend static files
  location /css/ {
    alias /app/frontend/css/;
    expires 7d;
    add_header Cache-Control "public, immutable";
  }

  location /html/ {
    alias /app/frontend/html/;
    expires 1h;
    add_header Cache-Control "public";
  }

  location /js/ {
    alias /app/frontend/js/;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
  }

  # Serve data files FIRST (before /api/)
  location /data/metadata/ {
    alias /app/data/metadata/;
    add_header Cache-Control "public, max-age=3600";
    add_header Content-Type "application/json";
  }

  location /data/URL/ {
    alias /app/data/URL/;
    add_header Cache-Control "public, max-age=3600";
    add_header Content-Type "application/json";
  }

  location /data/keyframe/ {
    alias /app/data/keyframe/keyframe/;
    add_header Cache-Control "public, max-age=3600";
  }

  # Serve frontend API client JavaScript files (exact paths)
  location /api/searchApi.js {
    alias /app/frontend/api/searchApi.js;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Content-Type "application/javascript";
  }

  location /api/client.js {
    alias /app/frontend/api/client.js;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Content-Type "application/javascript";
  }

  # Backend API endpoints - proxy to FastAPI
  location /api/search-new {
    proxy_pass http://web:8000/api/search-new;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_buffering off;
  }

  location /api/image-search {
    proxy_pass http://web:8000/api/image-search;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location /api/upload-query-image {
    proxy_pass http://web:8000/api/upload-query-image;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location ~ ^/api/image/(.+)$ {
    proxy_pass http://web:8000/api/image/$1$is_args$args;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
  }

  location /api/video-frames {
    proxy_pass http://web:8000/api/video-frames;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
  }

  location /health {
    proxy_pass http://web:8000/health;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
  }

  location /temp_uploads/ {
    proxy_pass http://web:8000/temp_uploads/;
    expires -1;
    add_header Cache-Control "no-store";
  }

  # Serve video files directly
  location /data/video/ {
    alias /app/data/video/;
    add_header Cache-Control "public, max-age=3600";
    add_header Accept-Ranges "bytes";
    try_files $uri =404;
  }

  # Gzip compression
  gzip on;
  gzip_types text/css application/javascript application/json image/svg+xml;

  # Internal protected keyframes - heavily cached in RAM
  location /protected/keyframe/ {
    internal;
    alias /app/data/keyframe/;
    
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Cache-Status "HIT-FROM-RAM";
    
    etag off;
    if_modified_since off;
    
    sendfile on;
    sendfile_max_chunk 10m;
    aio threads;
    directio 4m;
    output_buffers 2 10m;
    
    tcp_nopush on;
    tcp_nodelay off;
    
    expires max;
  }

}
