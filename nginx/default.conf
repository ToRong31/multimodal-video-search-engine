server {
  listen 80;
  server_name _;

  # Allow large file uploads (for query images)
  client_max_body_size 500M;
  client_body_timeout 120s;

  # File cache optimization - aggressive for 180GB RAM
  # Supporting 777k+ keyframe images
  open_file_cache max=1000000 inactive=365d;
  open_file_cache_valid 365d;
  open_file_cache_min_uses 1;
  open_file_cache_errors on;
  
  # Performance optimizations
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  # Serve video files directly from disk
location /data/video/ {
    alias /app/data/video/;
    add_header Cache-Control "public, max-age=3600";
    add_header Accept-Ranges "bytes";
    try_files $uri =404;
}


  # Serve static template assets
  location /template/ {
    alias /app/template/;
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri =404;
  }

  # Gzip compression
  gzip on;
  gzip_types text/css application/javascript application/json image/svg+xml;

  # Reverse proxy to FastAPI app in service `web`
  location / {
    proxy_pass http://web:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_buffering off;
  }

  # WebSocket proxy
  location /ws {
    proxy_pass http://chat:3001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
  }

  # Internal protected keyframes - heavily cached in RAM
  location /protected/keyframe/ {
    internal;
    alias /app/data/keyframe/;
    
    # Aggressive caching - keyframes don't change
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Cache-Status "HIT-FROM-RAM";
    
    # Disable ETag and Last-Modified for pure cache
    etag off;
    if_modified_since off;
    
    # Enable efficient file transfers with read-ahead
    sendfile on;
    sendfile_max_chunk 10m;
    aio threads;
    directio 4m;
    output_buffers 2 10m;
    
    # Optimize TCP for images - batch send
    tcp_nopush on;
    tcp_nodelay off;
    
    # Never expire from file cache
    expires max;
  }
}
